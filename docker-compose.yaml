version: '3.8'

services:
  # ============================================
  # MySQL Database
  # ============================================
  mysql:
    image: mysql:8.0
    container_name: finhub-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpassword}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-finhub_etl}
      MYSQL_USER: ${MYSQL_USER:-finhub_user}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-finhub_password}
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./etl-pipeline/migrations:/docker-entrypoint-initdb.d
    networks:
      - finhub-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD:-rootpassword}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # RabbitMQ Message Broker
  # ============================================
  rabbitmq:
    image: rabbitmq:3.12-management
    container_name: finhub-rabbitmq
    restart: unless-stopped
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-guest}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-guest}
      RABBITMQ_DEFAULT_VHOST: ${RABBITMQ_VHOST:-/}
    ports:
      - "5672:5672"    # AMQP port
      - "15672:15672"  # Management UI
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - finhub-network
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # ETL Pipeline Service
  # ============================================
  etl-pipeline:
    build:
      context: ./etl-pipeline
      dockerfile: Dockerfile
    container_name: finhub-etl-pipeline
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      # Database Configuration
      DATABASE_URL: mysql+aiomysql://${MYSQL_USER:-finhub_user}:${MYSQL_PASSWORD:-finhub_password}@mysql:3306/${MYSQL_DATABASE:-finhub_etl}
      SYNC_DATABASE_URL: mysql+pymysql://${MYSQL_USER:-finhub_user}:${MYSQL_PASSWORD:-finhub_password}@mysql:3306/${MYSQL_DATABASE:-finhub_etl}

      # Finnhub API
      FINHUB_API_KEY: ${FINHUB_API_KEY}

      # Application Settings
      PYTHONUNBUFFERED: 1
    volumes:
      - ./etl-pipeline/data:/app/data
      - ./etl-pipeline/logs:/app/logs
    networks:
      - finhub-network
    # Uncomment to override the default command
    # command: python -m finhub_etl.scheduler.base

  # ============================================
  # Database Migration Service (runs once)
  # ============================================
  etl-migrations:
    build:
      context: ./etl-pipeline
      dockerfile: Dockerfile
    container_name: finhub-etl-migrations
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      SYNC_DATABASE_URL: mysql+pymysql://${MYSQL_USER:-finhub_user}:${MYSQL_PASSWORD:-finhub_password}@mysql:3306/${MYSQL_DATABASE:-finhub_etl}
      PYTHONUNBUFFERED: 1
    networks:
      - finhub-network
    command: alembic upgrade head
    restart: "no"  # Run once and exit

  # ============================================
  # RabbitMQ Worker Service
  # ============================================
  worker:
    build:
      context: ./worker
      dockerfile: Dockerfile
    container_name: finhub-worker
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    environment:
      # Database Configuration
      DATABASE_URL: postgresql+asyncpg://${MYSQL_USER:-finhub_user}:${MYSQL_PASSWORD:-finhub_password}@mysql:3306/${MYSQL_DATABASE:-finhub_etl}

      # RabbitMQ Configuration
      RABBITMQ_URL: amqp://${RABBITMQ_USER:-guest}:${RABBITMQ_PASSWORD:-guest}@rabbitmq:5672/${RABBITMQ_VHOST:-/}
      RABBITMQ_QUEUE: ${RABBITMQ_QUEUE:-finhub_tasks}

      # Finnhub API
      FINHUB_API_KEY: ${FINHUB_API_KEY}

      # Worker Settings
      WORKER_CONCURRENCY: ${WORKER_CONCURRENCY:-1}
      PYTHONUNBUFFERED: 1
    volumes:
      - ./worker/logs:/app/logs
    networks:
      - finhub-network
    # Scale workers: docker-compose up -d --scale worker=3

  # ============================================
  # Optional: phpMyAdmin (MySQL Web UI)
  # ============================================
  phpmyadmin:
    image: phpmyadmin:latest
    container_name: finhub-phpmyadmin
    restart: unless-stopped
    depends_on:
      - mysql
    environment:
      PMA_HOST: mysql
      PMA_PORT: 3306
      PMA_USER: ${MYSQL_USER:-finhub_user}
      PMA_PASSWORD: ${MYSQL_PASSWORD:-finhub_password}
    ports:
      - "8080:80"
    networks:
      - finhub-network
    profiles:
      - tools  # Only start when using --profile tools

# ============================================
# Networks
# ============================================
networks:
  finhub-network:
    driver: bridge
    name: finhub-network

# ============================================
# Volumes
# ============================================
volumes:
  mysql_data:
    name: finhub-mysql-data
  rabbitmq_data:
    name: finhub-rabbitmq-data
